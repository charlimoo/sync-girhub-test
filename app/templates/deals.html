<!-- app/templates/deals.html -->
{% extends "base.html" %}

{% block content %}
<div class="container my-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Deal Creation Management</h2>
        <button id="save-button" class="btn btn-success btn-lg" disabled>
            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
            Save All Changes
        </button>
    </div>

    <!-- Configuration Instructions -->
    <div class="alert alert-info" role="alert">
        <h4 class="alert-heading">Configuration</h4>
        <p>
            To enable or disable this feature and to set the default Funnel Level ID, please visit the
            <a href="{{ url_for('main.mappings_page') }}" class="alert-link">Mappings page</a> and configure the "System Settings" type.
        </p>
    </div>

    <!-- NEW: Selected Trigger Products Card -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Selected Trigger Products (<span id="selected-count">0</span>)</h5>
        </div>
        <div class="card-body">
            <div id="selected-products-area">
                <!-- Selected products will be listed here -->
            </div>
        </div>
    </div>
    <!-- END NEW -->

    <!-- Main Management Card -->
    <div class="card">
        <div class="card-header">
            <div class="row g-3 align-items-end">
                <div class="col-md-8">
                    <label for="product-search" class="form-label">Search All Asanito Products</label>
                    <div class="input-group">
                        <input type="text" id="product-search" class="form-control" placeholder="Enter product name...">
                        <button id="search-button" class="btn btn-outline-secondary" type="button">
                            <i class="bi bi-search"></i> Search
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div id="status-area" class="text-center text-muted p-5">
                Loading products from Asanito...
            </div>
            <div id="table-area" class="d-none">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th style="width: 5%;"><input type="checkbox" id="select-all-checkbox" title="Select all on this page" class="form-check-input"></th>
                                <th style="width: 15%;">Product ID</th>
                                <th>Product Title</th>
                                <th style="width: 25%;">Category</th>
                            </tr>
                        </thead>
                        <tbody id="products-table-body">
                            <!-- Rows will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
                <nav id="pagination-nav" aria-label="Page navigation"></nav>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- UI Elements ---
    const saveButton = document.getElementById('save-button');
    const searchInput = document.getElementById('product-search');
    const searchButton = document.getElementById('search-button');
    const selectedProductsArea = document.getElementById('selected-products-area');
    const selectedCountSpan = document.getElementById('selected-count');
    const tableArea = document.getElementById('table-area');
    const tableBody = document.getElementById('products-table-body');
    const statusArea = document.getElementById('status-area');
    const paginationNav = document.getElementById('pagination-nav');
    const selectAllCheckbox = document.getElementById('select-all-checkbox');

    // --- State ---
    let currentPage = 1;
    let currentSearchTerm = '';
    let selectedProducts = new Map(); // Use a Map to store full product data: { id => productObject }
    let allProductsOnPage = []; 

    // --- API Functions ---
    async function fetchAsanitoProducts(page, search) {
        const params = new URLSearchParams({ page, search: search || '' });
        const response = await fetch(`/api/deals/asanito_products?${params.toString()}`);
        if (!response.ok) throw new Error((await response.json()).error || 'Failed to fetch products.');
        return response.json();
    }

    async function fetchSelectedProducts() {
        const response = await fetch('/api/deals/trigger_products');
        if (!response.ok) throw new Error((await response.json()).error || 'Failed to fetch selected products.');
        const data = await response.json();
        const productMap = new Map();
        (data.products || []).forEach(p => productMap.set(p.id, p));
        return productMap;
    }

    async function saveSelections() {
        toggleLoading(saveButton, true);
        try {
            // --- MODIFIED: Gather data directly from the DOM to capture user input ---
            const productsToSave = [];
            const selectedRows = document.querySelectorAll('#selected-products-area tbody tr');

            selectedRows.forEach(row => {
                const productId = parseInt(row.dataset.productId);
                const originalProductData = selectedProducts.get(productId);

                if (originalProductData) {
                    productsToSave.push({
                        id: productId,
                        title: originalProductData.title,
                        category: originalProductData.category,
                        funnel_id: row.querySelector('.funnel-id-input').value.trim(),
                        funnel_level_id: row.querySelector('.funnel-level-id-input').value.trim()
                    });
                }
            });
            // --- END OF MODIFICATION ---
            
            const response = await fetch('/api/deals/trigger_products', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ products: productsToSave })
            });
            if (!response.ok) throw new Error((await response.json()).error || 'Failed to save.');
            window.location.reload();
        } catch (error) {
            alert(`Error saving selections: ${error.message}`);
            toggleLoading(saveButton, false);
        }
    }

    // --- UI Rendering ---
    function renderSelectedProducts() {
        selectedProductsArea.innerHTML = '';
        selectedCountSpan.textContent = selectedProducts.size;
        if (selectedProducts.size === 0) {
            selectedProductsArea.innerHTML = `<p class="text-muted">No products selected. Check a product from the list below to add it here.</p>`;
            return;
        }

        const table = document.createElement('table');
        table.className = 'table table-sm table-striped';
        // --- MODIFIED: Add headers for Funnel ID and Funnel Level ID ---
        table.innerHTML = `
            <thead>
                <tr>
                    <th>Product Title</th>
                    <th style="width: 10%;">ID</th>
                    <th style="width: 15%;">Funnel ID</th>
                    <th style="width: 15%;">Funnel Level ID</th>
                    <th style="width: 10%;">Action</th>
                </tr>
            </thead>
            <tbody></tbody>`;
        // --- END OF MODIFICATION ---
        const tbody = table.querySelector('tbody');

        const sortedProducts = Array.from(selectedProducts.values()).sort((a, b) => a.title.localeCompare(b.title));

        sortedProducts.forEach(product => {
            const row = document.createElement('tr');
            row.dataset.productId = product.id; // Add data attribute for easier lookup on save
            
            // Handle null/undefined values gracefully for input fields
            const funnelIdValue = product.funnel_id === null || product.funnel_id === undefined ? '' : product.funnel_id;
            const funnelLevelIdValue = product.funnel_level_id === null || product.funnel_level_id === undefined ? '' : product.funnel_level_id;
            
            // --- MODIFIED: Add input fields for funnel configuration ---
            row.innerHTML = `
                <td>${product.title}</td>
                <td class="text-muted">${product.id}</td>
                <td><input type="number" class="form-control form-control-sm funnel-id-input" placeholder="Enter Funnel ID" value="${funnelIdValue}"></td>
                <td><input type="number" class="form-control form-control-sm funnel-level-id-input" placeholder="Enter Level ID" value="${funnelLevelIdValue}"></td>
                <td><button class="btn btn-sm btn-outline-danger remove-selected-btn" data-product-id="${product.id}">Remove</button></td>
            `;
            // --- END OF MODIFICATION ---
            tbody.appendChild(row);
        });
        selectedProductsArea.appendChild(table);
    }
    
    function renderAllProductsTable(products) {
        tableBody.innerHTML = '';
        allProductsOnPage = products;
        if (products.length === 0) {
            statusArea.innerHTML = `<div class="alert alert-secondary">No products found matching your search.</div>`;
            statusArea.classList.remove('d-none');
            tableArea.classList.add('d-none');
            return;
        }

        products.forEach(product => {
            const isChecked = selectedProducts.has(product.id);
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="checkbox" class="form-check-input product-checkbox" data-product-id="${product.id}" ${isChecked ? 'checked' : ''}></td>
                <td>${product.id}</td>
                <td>${product.title || '<em>N/A</em>'}</td>
                <td>${product.category ? product.category.title : '<em>Uncategorized</em>'}</td>
            `;
            tableBody.appendChild(row);
        });

        statusArea.classList.add('d-none');
        tableArea.classList.remove('d-none');
        updateSelectAllCheckboxState();
    }
    
    function renderPagination(data) {
        paginationNav.innerHTML = '';
        if (data.pages <= 1) return;
        let html = '<ul class="pagination justify-content-center">';
        html += `<li class="page-item ${data.page === 1 ? 'disabled' : ''}"><a class="page-link" href="#" data-page="${data.page - 1}">«</a></li>`;
        let start = Math.max(1, data.page - 2), end = Math.min(data.pages, data.page + 2);
        if (start > 1) html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
        for (let i = start; i <= end; i++) {
            html += `<li class="page-item ${i === data.page ? 'active' : ''}"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
        }
        if (end < data.pages) html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
        html += `<li class="page-item ${data.page === data.pages ? 'disabled' : ''}"><a class="page-link" href="#" data-page="${data.page + 1}">»</a></li>`;
        html += '</ul>';
        paginationNav.innerHTML = html;
    }

    function toggleLoading(button, isLoading) {
        const spinner = button.querySelector('.spinner-border');
        button.disabled = isLoading;
        if (spinner) spinner.classList.toggle('d-none', !isLoading);
    }

    function updateSelectAllCheckboxState() {
        const allOnPageChecked = allProductsOnPage.length > 0 && allProductsOnPage.every(p => selectedProducts.has(p.id));
        selectAllCheckbox.checked = allOnPageChecked;
    }

    // --- Main Logic ---
    async function loadAllProducts(page = 1, search = '') {
        statusArea.innerHTML = `<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>`;
        statusArea.classList.remove('d-none');
        tableArea.classList.add('d-none');

        try {
            currentPage = page;
            currentSearchTerm = search;
            const productData = await fetchAsanitoProducts(page, search);
            renderAllProductsTable(productData.items);
            renderPagination(productData);
        } catch (error) {
            statusArea.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
        }
    }

    // --- Event Listeners ---
    saveButton.addEventListener('click', saveSelections);
    searchButton.addEventListener('click', () => loadAllProducts(1, searchInput.value.trim()));
    searchInput.addEventListener('keyup', (e) => {
        if (e.key === 'Enter') loadAllProducts(1, searchInput.value.trim());
    });
    paginationNav.addEventListener('click', e => {
        e.preventDefault();
        const link = e.target.closest('a.page-link');
        if (link && !link.closest('.disabled')) {
            loadAllProducts(parseInt(link.dataset.page), currentSearchTerm);
        }
    });

    // Event delegation for checkbox changes in the main table
    tableBody.addEventListener('change', e => {
        if (e.target.matches('.product-checkbox')) {
            const productId = parseInt(e.target.dataset.productId);
            const product = allProductsOnPage.find(p => p.id === productId);
            if (e.target.checked) {
                selectedProducts.set(productId, product);
            } else {
                selectedProducts.delete(productId);
            }
            renderSelectedProducts();
            updateSelectAllCheckboxState();
        }
    });
    
    selectAllCheckbox.addEventListener('change', e => {
        const isChecked = e.target.checked;
        allProductsOnPage.forEach(product => {
            if (isChecked) {
                selectedProducts.set(product.id, product);
            } else {
                selectedProducts.delete(product.id);
            }
        });
        document.querySelectorAll('.product-checkbox').forEach(cb => cb.checked = isChecked);
        renderSelectedProducts();
    });

    // Event delegation for remove buttons in the selected list
    selectedProductsArea.addEventListener('click', e => {
        if (e.target.matches('.remove-selected-btn')) {
            const productId = parseInt(e.target.dataset.productId);
            selectedProducts.delete(productId);
            renderSelectedProducts();
            // Uncheck the corresponding checkbox in the main list if it's visible
            const checkbox = document.querySelector(`.product-checkbox[data-product-id="${productId}"]`);
            if (checkbox) checkbox.checked = false;
            updateSelectAllCheckboxState();
        }
    });

    // --- Initial Load ---
    async function initialize() {
        try {
            selectedProducts = await fetchSelectedProducts();
            renderSelectedProducts();
            await loadAllProducts(1, '');
            saveButton.disabled = false;
        } catch(error) {
            statusArea.innerHTML = `<div class="alert alert-danger">Initialization failed: ${error.message}</div>`;
        }
    }

    initialize();
});
</script>
{% endblock %}