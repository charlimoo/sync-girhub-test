<!-- app/templates/mappings.html -->
{% extends "base.html" %}

{% block content %}
<div class="container my-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Data Mappings</h2>
    </div>

    <div class="card">
        <div class="card-header">
            <div class="row align-items-end g-3">
                <div class="col-md-4">
                    <label for="mapTypeSelect" class="form-label">Mapping Type</label>
                    <select id="mapTypeSelect" class="form-select">
                        <option value="" selected disabled>-- Select a type --</option>
                        {% for key, config in mapping_configs.items() %}
                        <option value="{{ key }}">{{ config.display_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <button id="loadButton" class="btn btn-primary" disabled>
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        Load & Discover
                    </button>
                </div>
                <div class="col-md-4 text-md-end">
                    <button id="saveButton" class="btn btn-success" disabled>
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        Save All Mappings
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div id="status-message" class="text-muted text-center py-5">
                Please select a mapping type and click "Load & Discover".
            </div>
            <div id="table-area" class="d-none">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Source Name / Key</th>
                                <th>Source ID</th>
                                <th style="width: 40%;">Asanito Value / ID</th>
                            </tr>
                        </thead>
                        <tbody id="mapping-table-body">
                            <!-- Rows will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
                <nav id="pagination-nav" aria-label="Page navigation"></nav>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const select = document.getElementById('mapTypeSelect');
        const loadBtn = document.getElementById('loadButton');
        const saveBtn = document.getElementById('saveButton');
        const tableArea = document.getElementById('table-area');
        const tableBody = document.getElementById('mapping-table-body');
        const statusMessage = document.getElementById('status-message');
        const paginationNav = document.getElementById('pagination-nav');

        let currentPage = 1;
        let currentMapType = '';

        select.addEventListener('change', () => {
            currentMapType = select.value;
            loadBtn.disabled = !currentMapType;
            resetUI();
        });

        loadBtn.addEventListener('click', () => loadData(1));
        
        saveBtn.addEventListener('click', async () => {
            if (!currentMapType) return;
            toggleLoading(saveBtn, true);
            const mappingsToSave = [];
            document.querySelectorAll('#mapping-table-body tr').forEach(row => {
                const control = row.querySelector('input[name="asanito_id"], select[name="asanito_id"]');
                if (control && control.value.trim() !== '') {
                    mappingsToSave.push({
                        source_id: row.dataset.sourceId,
                        source_name: row.dataset.sourceName,
                        asanito_id: control.value.trim()
                    });
                }
            });
            try {
                const response = await fetch(`/mappings/save/${currentMapType}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mappings: mappingsToSave })
                });
                if (!response.ok) throw new Error((await response.json()).error || 'Failed to save.');
                window.location.reload();
            } catch (error) {
                alert(`Error saving: ${error.message}`);
            } finally {
                toggleLoading(saveBtn, false);
            }
        });

        function resetUI() {
            saveBtn.disabled = true;
            tableArea.classList.add('d-none');
            statusMessage.classList.remove('d-none');
            statusMessage.textContent = 'Please select a mapping type and click "Load & Discover".';
            paginationNav.innerHTML = '';
        }

        async function loadData(page) {
            if (!currentMapType) return;
            toggleLoading(loadBtn, true);
            statusMessage.textContent = 'Loading data...';
            statusMessage.classList.remove('d-none');
            tableArea.classList.add('d-none');

            try {
                const response = await fetch(`/mappings/data/${currentMapType}?page=${page}`);
                if (!response.ok) throw new Error((await response.json()).error || 'Failed to fetch data.');
                
                const data = await response.json();
                currentPage = data.page;

                // Pass the full mapping configs from Jinja to JavaScript
                const fullConfig = {{ mapping_configs | tojson }};
                const currentConfig = fullConfig[currentMapType];

                // For manual types, augment the server data with control info from our config
                if (currentConfig && currentConfig.is_manual) {
                    data.items.forEach(item => {
                        const keyConfig = currentConfig.keys[item.source_id];
                        if (typeof keyConfig === 'object' && keyConfig.control_type) {
                            item.control_type = keyConfig.control_type;
                            item.options = keyConfig.options;
                        }
                    });
                }

                renderTable(data.items);
                renderPagination(data);
                saveBtn.disabled = data.total === 0;

            } catch (error) {
                statusMessage.textContent = `Error: ${error.message}`;
            } finally {
                toggleLoading(loadBtn, false);
            }
        }
        
        function renderTable(items) {
            tableBody.innerHTML = '';
            if (items.length === 0) {
                statusMessage.textContent = 'No values discovered or saved for this type.';
                return;
            }
            items.forEach(item => {
                const row = document.createElement('tr');
                row.dataset.sourceId = item.source_id;
                row.dataset.sourceName = item.source_name || '';

                // Dynamically create either an input or a select control based on item data
                let controlHtml = '';
                if (item.control_type === 'select') {
                    controlHtml = `<select class="form-select" name="asanito_id">`;
                    if (item.options) {
                        item.options.forEach(opt => {
                            const isSelected = (opt.value == item.asanito_id) ? 'selected' : '';
                            controlHtml += `<option value="${opt.value}" ${isSelected}>${opt.text}</option>`;
                        });
                    }
                    controlHtml += `</select>`;
                } else {
                    controlHtml = `<input type="text" class="form-control" name="asanito_id" value="${item.asanito_id || ''}" placeholder="Enter Asanito Value/ID">`;
                }

                row.innerHTML = `
                    <td>${item.source_name || '<em>N/A</em>'}</td>
                    <td style="font-family: monospace; font-size: 0.8rem;">${item.source_id}</td>
                    <td>${controlHtml}</td>
                `;
                tableBody.appendChild(row);
            });
            statusMessage.classList.add('d-none');
            tableArea.classList.remove('d-none');
        }

        function renderPagination(data) {
            paginationNav.innerHTML = '';
            if (data.pages <= 1) return;

            const ul = document.createElement('ul');
            ul.className = 'pagination justify-content-center';
            
            // Previous
            let li = document.createElement('li');
            li.className = `page-item ${data.page === 1 ? 'disabled' : ''}`;
            li.innerHTML = `<a class="page-link" href="#" data-page="${data.page - 1}">«</a>`;
            ul.appendChild(li);

            // Page numbers
            for (let i = 1; i <= data.pages; i++) {
                li = document.createElement('li');
                li.className = `page-item ${i === data.page ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
                ul.appendChild(li);
            }

            // Next
            li = document.createElement('li');
            li.className = `page-item ${data.page === data.pages ? 'disabled' : ''}`;
            li.innerHTML = `<a class="page-link" href="#" data-page="${data.page + 1}">»</a>`;
            ul.appendChild(li);

            paginationNav.appendChild(ul);
        }
        
        paginationNav.addEventListener('click', e => {
            e.preventDefault();
            if (e.target.tagName === 'A' && e.target.dataset.page) {
                const page = parseInt(e.target.dataset.page);
                if (page !== currentPage) {
                    loadData(page);
                }
            }
        });

        function toggleLoading(button, isLoading) {
            const spinner = button.querySelector('.spinner-border');
            button.disabled = isLoading;
            if (spinner) {
                spinner.classList.toggle('d-none', !isLoading);
            }
        }
    });
</script>
{% endblock %}